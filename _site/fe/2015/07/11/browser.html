<!DOCTYPE html>
<html>
  <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>浏览器的渲染 - 王雅轩</title>
        <meta name="author" content="王雅轩" />
        <meta name="description" content="浏览器的渲染" />
        <meta name="keywords" content="浏览器的渲染, 王雅轩, fe" />

        <meta content="0" property="fb:app_id">
        <meta content="王雅轩" property="og:site_name">
        
          <meta content="浏览器的渲染" property="og:title">
        
        
          <meta content="article" property="og:type">
        
        
          <meta content="My Personal Blog" property="og:description">
        
        
          <meta content="http://localhost:4000/fe/2015/07/11/browser.html" property="og:url">
        
        
          <meta content="2015-07-11T00:00:00+08:00" property="article:published_time">
          <meta content="http://localhost:4000/about/" property="article:author">
        
        
          <meta content="http://localhost:4000/static/img/logo-high-resolution.png" property="og:image">
        
        
          
          <meta content="fe" property="article:section">
          
        
        
          
          <meta content="http" property="article:tag">
          
        
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@\#">
        <meta name="twitter:creator" content="@\#">
        
          <meta name="twitter:title" content="浏览器的渲染">
        
        
          <meta name="twitter:url" content="http://localhost:4000/fe/2015/07/11/browser.html">
        
        
          <meta name="twitter:description" content="My Personal Blog">
        
        

      <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
      <script type="text/javascript">window.baseurl = 'http://localhost:4000';</script>
      
        <!-- Custom Fonts -->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

        <!-- FontAwesome icons -->
        <link rel="stylesheet" href="https://use.fontawesome.com/74dfc6cf47.css">

        <!-- Core BootStrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <!-- Material Design CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap-material-design.min.css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <!-- Custom CSS -->        
        <link rel="stylesheet" href="/static/css/thickbox.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="stylesheet" href="/static/css/projects.css">

        <script type="text/javascript">
          //loadingImage is relative to project dir
          var tb_pathToImage = "/static/img/loadingAnimation.gif";
        </script>

  </head>

  <body class="home overflow-hidden">
    <div class="header-panel shadow-z-2">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-sm-4 col-xs-12">
            <div class="row-picture">
              <img id="about" class="logo-img" src="https://github.com/wangyaxuanFE/blog/blob/master/static/img/guan.jpg" height="75px" width="75px">
            </div>
            <div class="row-details">
              <h4 class="list-group-item-heading">王雅轩</h4>
              <p class="list-group-item-text">Freelance developer</p>
              <div class="social-icons">
	
        <a class="icon" target="_blank" href=""><i class="fa fa-facebook"></i></a>
    
        <a class="icon" target="_blank" href=""><i class="fa fa-twitter"></i></a>
    
        <a class="icon" target="_blank" href=""><i class="fa fa-linkedin"></i></a>
    
        <a class="icon" target="_blank" href=""><i class="fa fa-stack-exchange"></i></a>
    
</div>

            </div>
            <div class="navbar-header pull-right">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-2x fa-bars"></i>
              </button>
            </div>
          </div>
          <div class="col-md-9 col-sm-8 col-xs-12">
          <div class="row">
            <h2 class="blog-title-pro col-md-6 col-sm-12 col-xs-12 ">浏览器的渲染</h2>
            
            <div class="col-md-6 col-sm-12 col-xs-12 searchcontrol" id="js-search">
              <input class="form-control" type="text" id="js-search__input" placeholder="Search">
              <ul class="search__results" id="js-search__results"></ul>
            </div>
            
            </div>
            <p class="info">
              
                <span class="time">11 Jul 2015</span>
              
              
                <span class="categories">
                  &raquo; 
                  
                    <a href="/category/fe">fe</a>
                    
                  
                </span>
              
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container main outer">
      <div class="row">
        <div class="col-md-3 col-xs-12">
              <nav class="menu">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="list-separator nav navbar-nav well well-primary page">

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  browser.html"><a href="/"><i class="fa fa-home"></i> Home</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  browser.html"><a href="/about/"><i class="fa fa-comments"></i> About</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  browser.html"><a href="/projects"><i class="fa fa-desktop"></i> Projects</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  browser.html"><a href="/#"><i class="fa fa-graduation-cap"></i> Resume</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  browser.html"><a href="/#"><i class="fa fa-github"></i> Github</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  browser.html"><a href="/feed.xml"><i class="fa fa-feed"></i> XML Feed</a></li>

</ul>

    </div>
    </nav>

        </div>
        <div class="col-md-9 col-xs-12 full">
          <div class="well">
    
    <div>
    	<h3 id="浏览器都做了什么">浏览器都做了什么</h3>
<hr />
<p>我们希望浏览器打开一个简单的网页</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">The</span> <span class="s2">"Click the button"</span> <span class="nx">page</span><span class="o">&lt;</span><span class="sr">/title</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"styles.css"</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span>
      <span class="nx">Click</span> <span class="nx">the</span> <span class="nx">button</span><span class="p">.</span>
    <span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"button"</span><span class="o">&gt;</span><span class="nx">Click</span> <span class="nx">me</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
      <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"button"</span><span class="p">);</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">fontWeight</span> <span class="o">=</span> <span class="s2">"bold"</span><span class="p">;</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"click"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">"Well done."</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre>
</div>

<h3 id="浏览器如何渲染网页">浏览器如何渲染网页</h3>
<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>1.使用 HTML 创建文档对象模型（DOM）
2.使用 CSS 创建 CSS 对象模型（CSSOM）
3.基于 DOM 和 CSSOM 执行脚本（Scripts）
4.合并 DOM 和 CSSOM 形成渲染树（Render Tree）
5.使用渲染树布局（Layout）所有元素
6.渲染（Paint）所有元素
</code></pre>
</div>

<p><img src="/static/img/fe-liu-2.png" alt="image" /></p>

<h3 id="步骤一--html">步骤一 — HTML</h3>
<hr />

<p>浏览器从上到下读取标签，把他们分解成节点，从而创建 DOM 。</p>

<p><img src="/static/img/fe-liu-1.png" alt="image" /></p>

<h3 id="html-加载优化策略">HTML 加载优化策略</h3>
<hr />

<ul>
  <li>最小化和压缩
方法可用于所有内容，包括 HTML，CSS，JavaScript，图片和其它资源。
最小化是移除所有多余的字符，包括空格，注释，多余的分号，等等
压缩比如 GZip，大大压缩下载文件的大小
两种方法都用的情况下，资源加载量减少了 80% 到 90%。比如：bootstrap 节省了 87% 的流量。</li>
  <li>无障碍
不会提升页面的下载速度，但会大大提升残障人士的满意度。给元素加上 aria 标签，图片提供 alt 文本，HTML 5 无障碍参见。
使用诸如 <a href="http://wave.webaim.org/">WAVE</a> 的工具鉴别哪些地方可以提高可访问性。</li>
</ul>

<h3 id="步骤二--css">步骤二 — CSS</h3>
<hr />

<p>当浏览器发现任何与节点相关的样式时，比如：外部，内部，或行内样式，立即停止渲染 DOM ，并利用这些节点创建 CSSOM。这就是 CSS <strong>“渲染阻塞“</strong> 的由来。这里是不同类型样式的优缺点。</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code>    <span class="c1">//外部样式</span>
    <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"styles.css"</span><span class="o">&gt;</span>
    <span class="c1">// 内部样式</span>
    <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
      <span class="nx">h1</span> <span class="p">{</span>
        <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="err">:</span> <span class="mi">18</span><span class="nx">px</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="o">&lt;</span><span class="sr">/style</span><span class="err">&gt;
</span>    <span class="c1">// 行内样式</span>
</code></pre>
</div>
<p>CSSOM 节点创建与 DOM 节点创建类似，随后，两者合并如下：
<img src="/static/img/fe-liu-3.png" alt="image" />
CSSOM 的构建会阻塞页面的渲染，因此我们想尽早加载样式，</p>

<h3 id="css-加载优化策略">CSS 加载优化策略</h3>
<hr />

<ul>
  <li>使用 media 属性
media 属性指定加载样式的条件，比如：符合最大或最小分辨率？还是面向屏幕阅读器？</li>
  <li>延迟加载 CSS
有些样式，比如：首屏以下的，或者不那么重要的，可以等待首屏最有价值的内容渲染完成再加载，可以使用脚本等待页面加载，然后再插入样式。</li>
</ul>

<p>这有两个栗子：<a href="https://jakearchibald.com/2016/link-in-body/">The future of loading CSS</a>，<a href="https://www.giftofspeed.com/defer-loading-css/">Defer load CSS</a></p>

<ul>
  <li>只加载需要的样式
使用 <a href="https://github.com/giakki/uncss">uncss</a> 类似的工具，尽量移除不需要的样式。</li>
</ul>

<h3 id="步骤三--javascript">步骤三 — JavaScript</h3>
<hr />

<p>浏览器不断构建 DOM / CSSOM 节点，直到发现外部或者行内的脚本。
由于脚本可能需要访问或操作之前的 HTML 或样式，我们必须等待它们构建完成。
因此浏览器必须停止解析节点，完成构建 CSSOM，执行脚本，然后再继续。这就是 JavaScript 被称作<strong>“解析器阻塞”</strong>的原因。
脚本只能等到先前的 CSS 节点构建完成。
<img src="/static/img/fe-liu-4.png" alt="image" /></p>

<h3 id="javascript-加载优化策略">JavaScript 加载优化策略</h3>
<hr />
<ul>
  <li>
    <p>异步加载脚本
脚本添加<strong>async</strong>属性，可以通知浏览器不要阻塞其余页面的加载，下载脚本处于较低的优先级。一旦下载完成，就可以执行。
<img src="/static/img/fe-liu-5.png" alt="image" />
<strong>async</strong>适用于不影响 DOM 或 CSSOM 的脚本，对一些跟我们的代码无关的，不影响用户体验的外部脚本尤其适用，比如：分析统计脚本。</p>
  </li>
  <li>延迟加载脚本
<strong>defer</strong> 跟 <strong>async</strong> 非常相似，不会阻塞页面加载，但会等到 HTML 完成解析后再执行。
<img src="/static/img/fe-liu-6.png" alt="image" />
使用 <strong><a href="https://varvy.com/pagespeed/defer-loading-javascript.html">defer</a></strong> 策略的 另一个好选择，或者也可以使用 addEventListener，了解更多，参加这里。
不幸的是 <strong>async</strong> 和 <strong>defer</strong> 对于行内的脚本不起作用，浏览器默认会编译执行它们。</li>
  <li>
    <p>操作之前克隆节点
多次操作 DOM 时可以尝试，首先克隆整个 DOM 节点更加高效，操作克隆后的节点，然后替换先前的节点，避免了多次重绘，降低了 CPU 和内存消耗，同时也避免了不必要的页面闪烁。
需要注意，克隆的时候并没有克隆事件监听。</p>
  </li>
  <li>Preload/Prefetch/Prerender/Preconnect
这些新属性并不是所有的浏览器都支持。了解详情可以看这里：<a href="https://css-tricks.com/prefetching-preloading-prebrowsing/">Prefetching, preloading, prebrowsing</a></li>
</ul>

<h3 id="步骤四--渲染树render-tree">步骤四 — 渲染树（Render Tree）</h3>
<hr />
<p>一旦所有节点已被解析，DOM 和 CSSOM 准备合并，浏览器便会构建渲染树。如果我们把节点想象成单词，那么对象模型就是句子，渲染树便是整个页面。</p>

<p><img src="/static/img/fe-liu-7.png" alt="image" /></p>

<h3 id="步骤五--布局layout">步骤五 — 布局（Layout）</h3>
<hr />
<p>布局阶段需要确定页面上所有元素的大小和位置。
<img src="/static/img/fe-liu-8.png" alt="image" /></p>

<h3 id="步骤六--渲染paint">步骤六 — 渲染（Paint）</h3>
<hr />
<p>最终的渲染阶段，会真正地光栅化屏幕上的像素，把页面呈现给用户。
<img src="/static/img/fe-liu-9.png" alt="image" />
整个过程耗时1秒或十分之一秒，我们的任务是让它更快。
如果 JavaScript 事件改变了页面的某部分，便会引起渲染树的重绘，并且迫使布局（Layout）和渲染（Paint）过程再次进行。</p>

<h3 id="浏览器如何发起网络请求">浏览器如何发起网络请求</h3>
<hr />
<p>当浏览器请求一个 URL，服务端会响应一些 HTML。
我们需要认识一个新术语，关键渲染路径（Critical Rendering Path (CRP)），就是浏览器渲染页面的步骤数，如下图。</p>

<p><img src="/static/img/fe-liu-10.png" alt="image" /></p>

<h3 id="关键路径长度">关键路径长度</h3>
<hr />
<p>关键渲染路径的度量标准是路径长度。最理想的关键路径长度是1。
如果页面包含一些内部样式和 JavaScript ，关键路径发生以下改变。
<img src="/static/img/fe-liu-11.png" alt="image" />
新增两步，构建 CSSOM和执行脚本，因为我们的 HTML 有内部样式和脚本需要计算。由于没有外部请求，我们的关键路径长度没变。
但是注意，我们的 HTML 大小增加到了 2kb，某些地方还是受了影响。</p>

<h3 id="关键字节数">关键字节数</h3>
<hr />
<p>三个度量标准之二出现了，关键字节数，它用来衡量渲染页面需要传送多少字节数。
如果你认为不需要外部资源，就大错特错了，外部资源可以被缓存。
我们使用一个外部 CSS 文件，一个外部 JavaScript 文件，和一个外部带 async 属性的 JavaScript 文件。关键路径图如下：</p>

<p><img src="/static/img/fe-liu-12.png" alt="image" />
浏览器请求页面，构建 DOM，发现外部资源后开始下载，CSS 和 JavaScript 有较高的优先级，其它资源次之。
<strong>styles.css</strong> 和 <strong>app.js</strong> 通过另一个关键路径获取。暂时不获取 analytics.js ，因为加了 async 属性，浏览器将用另一个线程下载它，它处于较低优先级，不会阻塞页面渲染，也不影响关键路径。</p>

<h3 id="关键文件">关键文件</h3>
<hr />
<p>最后一个度量标准是关键文件，浏览器渲染页面需要下载的文件总量。以上例子，<strong>*HTML 文件，CSS 和 JavaScript</strong>文件算关键文件，<strong>async</strong> 的脚本不算。当然是文件越少越好。</p>

<h3 id="综述">综述</h3>
<hr />
<p>关键渲染路径是最重要的，它使得网站优化有规律可循。需要关注3个指标：</p>
<ol>
  <li>关键字节数</li>
  <li>关键文件数</li>
  <li>关键路径长度</li>
</ol>


    </div>
</div>

          <div class="row">
            <div class="col-md-12 col-xs-12 footer">
              <footer>
  © 2016 Your Name <a href="#">Privacy link</a> - Powered by Jekyll.
</footer>
<div align="center">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-0000000000000000"
    data-ad-slot="0000000000"
    data-ad-format="auto"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>

            </div>
          </div>
        </div> <!-- end /.col-md-9 -->
      </div> <!-- end /.row -->
    </div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="/static/js/super-search.js"></script>

<script src="/static/js/thickbox-compressed.js"></script>
<script src="/static/js/material.min.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/js/projects.js"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72862926-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
