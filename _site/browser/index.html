<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>浏览器的渲染 - Hello, world!</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Hello, world!" property="og:site_name">
  
    <meta content="浏览器的渲染" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="nothing important.
" property="og:description">
  
  
    <meta content="http://localhost:4000/browser/" property="og:url">
  
  
    <meta content="2017-09-12T18:32:20+08:00" property="article:published_time">
    <meta content="http://localhost:4000/about/" property="article:author">
  
  
    <meta content="http://localhost:4000/assets/img/yuanyuan.jpg" property="og:image">
  
  
    
  
  
    
    <meta content="Holidays" property="article:tag">
    
    <meta content="Hawaii" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="浏览器的渲染">
  
  
    <meta name="twitter:url" content="http://localhost:4000/browser/">
  
  
    <meta name="twitter:description" content="nothing important.
">
  
  
    <meta name="twitter:image:src" content="http://localhost:4000/assets/img/yuanyuan.jpg">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/">
            <img src="/assets/img/yuanyuan.jpg" alt="Wang Yaxuan">
        </a>
      </div>
      <div class="author-name">Wang Yaxuan</div>
      <p>I am a web developer focusing on front-end development.</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <!--  -->
          <!-- <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li> -->
        <!--  -->
        <!-- 
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
         -->
        
          <li class="github"><a href="http://github.com/https://github.com/wangyaxuanFE/blog" target="_blank"><i class="fa fa-github"></i></a></li>
        
        <!-- 
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
         -->
        
          <li class="email"><a href="mailto:18518389424@163.com"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2019 &copy; Wang Yaxuan</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/yuanyuan.jpg alt="浏览器的渲染">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">浏览器的渲染</h1>
        <div class="page-date"><span>2017, Sep 12&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h3 id="浏览器都做了什么">浏览器都做了什么</h3>
<hr />

<p>我们希望浏览器打开一个简单的网页</p>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">The</span> <span class="s2">"Click the button"</span> <span class="nx">page</span><span class="o">&lt;</span><span class="sr">/title</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"styles.css"</span> <span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span>
      <span class="nx">Click</span> <span class="nx">the</span> <span class="nx">button</span><span class="p">.</span>
    <span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"button"</span><span class="o">&gt;</span><span class="nx">Click</span> <span class="nx">me</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
      <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">"button"</span><span class="p">);</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">fontWeight</span> <span class="o">=</span> <span class="s2">"bold"</span><span class="p">;</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">"click"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">"Well done."</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span></code></pre>
</div>

<h3 id="浏览器如何渲染网页">浏览器如何渲染网页</h3>
<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>1.使用 HTML 创建文档对象模型（DOM）
2.使用 CSS 创建 CSS 对象模型（CSSOM）
3.基于 DOM 和 CSSOM 执行脚本（Scripts）
4.合并 DOM 和 CSSOM 形成渲染树（Render Tree）
5.使用渲染树布局（Layout）所有元素
6.渲染（Paint）所有元素
</code></pre>
</div>

<!-- ![image](/assets/img/fe-liu-2.png) -->

<h3 id="步骤一--html">步骤一 — HTML</h3>
<hr />

<p>浏览器从上到下读取标签，把他们分解成节点，从而创建 DOM 。</p>

<!-- ![image](/assets/img/fe-liu-1.png) -->

<h3 id="html-加载优化策略">HTML 加载优化策略</h3>
<hr />

<ul>
  <li>最小化和压缩
方法可用于所有内容，包括 HTML，CSS，JavaScript，图片和其它资源。
最小化是移除所有多余的字符，包括空格，注释，多余的分号，等等
压缩比如 GZip，大大压缩下载文件的大小
两种方法都用的情况下，资源加载量减少了 80% 到 90%。比如：bootstrap 节省了 87% 的流量。</li>
  <li>无障碍
不会提升页面的下载速度，但会大大提升残障人士的满意度。给元素加上 aria 标签，图片提供 alt 文本，HTML 5 无障碍参见。
使用诸如 <a href="http://wave.webaim.org/">WAVE</a> 的工具鉴别哪些地方可以提高可访问性。</li>
</ul>

<h3 id="步骤二--css">步骤二 — CSS</h3>
<hr />

<p>当浏览器发现任何与节点相关的样式时，比如：外部，内部，或行内样式，立即停止渲染 DOM ，并利用这些节点创建 CSSOM。这就是 CSS <strong>“渲染阻塞“</strong> 的由来。这里是不同类型样式的优缺点。</p>
<div class="language-js highlighter-rouge"><pre class="highlight"><code>    <span class="c1">//外部样式</span>
    <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nx">href</span><span class="o">=</span><span class="s2">"styles.css"</span><span class="o">&gt;</span>
    <span class="c1">// 内部样式</span>
    <span class="o">&lt;</span><span class="nx">style</span><span class="o">&gt;</span>
      <span class="nx">h1</span> <span class="p">{</span>
        <span class="nx">font</span><span class="o">-</span><span class="nx">size</span><span class="err">:</span> <span class="mi">18</span><span class="nx">px</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="o">&lt;</span><span class="sr">/style</span><span class="err">&gt;
</span>    <span class="c1">// 行内样式</span>
</code></pre>
</div>
<p>CSSOM 节点创建与 DOM 节点创建类似，随后，两者合并如下：
<!-- ![image](/assets/img/fe-liu-3.png) -->
CSSOM 的构建会阻塞页面的渲染，因此我们想尽早加载样式，</p>

<h3 id="css-加载优化策略">CSS 加载优化策略</h3>
<hr />

<ul>
  <li>使用 media 属性
media 属性指定加载样式的条件，比如：符合最大或最小分辨率？还是面向屏幕阅读器？</li>
  <li>延迟加载 CSS
有些样式，比如：首屏以下的，或者不那么重要的，可以等待首屏最有价值的内容渲染完成再加载，可以使用脚本等待页面加载，然后再插入样式。</li>
</ul>

<p>这有两个栗子：<a href="https://jakearchibald.com/2016/link-in-body/">The future of loading CSS</a>，<a href="https://www.giftofspeed.com/defer-loading-css/">Defer load CSS</a></p>

<ul>
  <li>只加载需要的样式
使用 <a href="https://github.com/giakki/uncss">uncss</a> 类似的工具，尽量移除不需要的样式。</li>
</ul>

<h3 id="步骤三--javascript">步骤三 — JavaScript</h3>
<hr />

<p>浏览器不断构建 DOM / CSSOM 节点，直到发现外部或者行内的脚本。
由于脚本可能需要访问或操作之前的 HTML 或样式，我们必须等待它们构建完成。
因此浏览器必须停止解析节点，完成构建 CSSOM，执行脚本，然后再继续。这就是 JavaScript 被称作<strong>“解析器阻塞”</strong>的原因。
脚本只能等到先前的 CSS 节点构建完成。
<!-- ![image](/assets/img/fe-liu-4.png) --></p>

<h3 id="javascript-加载优化策略">JavaScript 加载优化策略</h3>
<hr />

<ul>
  <li>
    <p>异步加载脚本
脚本添加<strong>async</strong>属性，可以通知浏览器不要阻塞其余页面的加载，下载脚本处于较低的优先级。一旦下载完成，就可以执行。
<!-- ![image](/assets/img/fe-liu-5.png) -->
<strong>async</strong>适用于不影响 DOM 或 CSSOM 的脚本，对一些跟我们的代码无关的，不影响用户体验的外部脚本尤其适用，比如：分析统计脚本。</p>
  </li>
  <li>延迟加载脚本
<strong>defer</strong> 跟 <strong>async</strong> 非常相似，不会阻塞页面加载，但会等到 HTML 完成解析后再执行。
<!-- ![image](/assets/img/fe-liu-6.png)s -->
使用 <strong><a href="https://varvy.com/pagespeed/defer-loading-javascript.html">defer</a></strong> 策略的 另一个好选择，或者也可以使用 addEventListener，了解更多，参加这里。
不幸的是 <strong>async</strong> 和 <strong>defer</strong> 对于行内的脚本不起作用，浏览器默认会编译执行它们。</li>
  <li>
    <p>操作之前克隆节点
多次操作 DOM 时可以尝试，首先克隆整个 DOM 节点更加高效，操作克隆后的节点，然后替换先前的节点，避免了多次重绘，降低了 CPU 和内存消耗，同时也避免了不必要的页面闪烁。
需要注意，克隆的时候并没有克隆事件监听。</p>
  </li>
  <li>Preload/Prefetch/Prerender/Preconnect
这些新属性并不是所有的浏览器都支持。了解详情可以看这里：<a href="https://css-tricks.com/prefetching-preloading-prebrowsing/">Prefetching, preloading, prebrowsing</a></li>
</ul>

<h3 id="步骤四--渲染树render-tree">步骤四 — 渲染树（Render Tree）</h3>
<hr />

<p>一旦所有节点已被解析，DOM 和 CSSOM 准备合并，浏览器便会构建渲染树。如果我们把节点想象成单词，那么对象模型就是句子，渲染树便是整个页面。</p>

<!-- ![image](/assets/img/fe-liu-7.png) -->

<h3 id="步骤五--布局layout">步骤五 — 布局（Layout）</h3>
<hr />

<p>布局阶段需要确定页面上所有元素的大小和位置。
<!-- ![image](/assets/img/fe-liu-8.png) --></p>

<h3 id="步骤六--渲染paint">步骤六 — 渲染（Paint）</h3>
<hr />

<p>最终的渲染阶段，会真正地光栅化屏幕上的像素，把页面呈现给用户。
<!-- ![image](/assets/img/fe-liu-9.png) -->
整个过程耗时1秒或十分之一秒，我们的任务是让它更快。
如果 JavaScript 事件改变了页面的某部分，便会引起渲染树的重绘，并且迫使布局（Layout）和渲染（Paint）过程再次进行。</p>

<h3 id="浏览器如何发起网络请求">浏览器如何发起网络请求</h3>
<hr />

<p>当浏览器请求一个 URL，服务端会响应一些 HTML。
我们需要认识一个新术语，关键渲染路径（Critical Rendering Path (CRP)），就是浏览器渲染页面的步骤数，如下图。</p>

<!-- ![image](/assets/img/fe-liu-10.png) -->

<h3 id="关键路径长度">关键路径长度</h3>
<hr />

<div class="highlighter-rouge"><pre class="highlight"><code>1 关键资源：html, css, js
2 js异步加载，不阻塞渲染，脱离的关键路径。
3 css 优化一部分，首屏不加载（如媒体查询）也有一部分脱离了关键路径。
4 此时只剩下html,这部分优化的很有限。
- 如此减少了关键渲染路径长度，优化了首屏的加载速度。
- 另外，最理想的关键路径长度是1。
</code></pre>
</div>

<h3 id="关键字节数">关键字节数</h3>
<hr />

<p>三个度量标准之二出现了，关键字节数，它用来衡量渲染页面需要传送多少字节数。
如果你认为不需要外部资源，就大错特错了，外部资源可以被缓存。
我们使用一个外部 CSS 文件，一个外部 JavaScript 文件，和一个外部带 async 属性的 JavaScript 文件。关键路径图如下：</p>

<!-- ![image](/assets/img/fe-liu-12.png) -->
<p>浏览器请求页面，构建 DOM，发现外部资源后开始下载，CSS 和 JavaScript 有较高的优先级，其它资源次之。
<strong>styles.css</strong> 和 <strong>app.js</strong> 通过另一个关键路径获取。暂时不获取 analytics.js ，因为加了 async 属性，浏览器将用另一个线程下载它，它处于较低优先级，不会阻塞页面渲染，也不影响关键路径。</p>

<h3 id="关键文件">关键文件</h3>
<hr />

<p>最后一个度量标准是关键文件，浏览器渲染页面需要下载的文件总量。以上例子，<strong>*HTML 文件，CSS 和 JavaScript</strong>文件算关键文件，<strong>async</strong> 的脚本不算。当然是文件越少越好。</p>

<h3 id="综述">综述</h3>
<hr />

<p>关键渲染路径是最重要的，它使得网站优化有规律可循。需要关注3个指标：</p>
<ol>
  <li>关键字节数</li>
  <li>关键文件数</li>
  <li>关键路径长度</li>
</ol>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=浏览器的渲染&url=http://localhost:4000/browser/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=http://localhost:4000/browser/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=http://localhost:4000/browser/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/tags#Holidays" class="tag">&#35; Holidays</a>
          
            <a href="/tags#Hawaii" class="tag">&#35; Hawaii</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//mr-brown.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
